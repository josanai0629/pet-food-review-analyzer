<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒšãƒƒãƒˆãƒ•ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background-color: #e8f5e9;
        }
        .upload-area.dragover {
            background-color: #c8e6c9;
            border-color: #2E7D32;
        }
        .file-input {
            display: none;
        }
        .upload-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        .upload-button:hover {
            background-color: #45a049;
        }
        .progress {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .stats {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .sentiment-summary {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .sample-results {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
        .success {
            color: #388e3c;
            font-weight: bold;
        }
        .file-list {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .remove-file {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .remove-file:hover {
            background-color: #d32f2f;
        }
        .debug-button {
            background-color: #ff9800;
            margin-left: 10px;
        }
        .debug-button:hover {
            background-color: #f57c00;
        }
        .master-info {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            border-left: 4px solid #4CAF50;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ãƒšãƒƒãƒˆãƒ•ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="upload-area" id="uploadArea">
            <p>ã“ã“ã«Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" multiple>
            <label for="fileInput" class="upload-button">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
            <p style="margin-top: 20px; font-size: 14px; color: #666;">
                å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ï¼š<br>
                1. Raw_Review.xlsxï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰<br>
                2. Master.xlsxï¼ˆãƒ©ãƒ™ãƒ«ãƒã‚¹ã‚¿ãƒ¼ï¼‰â€»ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            </p>
            <div class="master-info">
                <strong>ğŸ¯ Master.xlsxã®æ–°å½¢å¼ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ï¼‰ï¼š</strong><br>
                Aåˆ—ï¼šãƒ©ãƒ™ãƒ«åã€Båˆ—ï¼šå„ªå…ˆåº¦ï¼ˆæ•°å€¤ï¼‰ã€Cåˆ—ï¼šåˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ|åŒºåˆ‡ã‚Šï¼‰<br>
                ä¾‹ï¼šA1=ã€Œé…é€ãƒ»æ¢±åŒ…ã€ã€B1=1ã€C1=ã€Œé…é€|æ¢±åŒ…|ç™ºé€|å±Šã|ç®±ã€<br>
                â€»å¾“æ¥å½¢å¼ï¼ˆAåˆ—ã®ã¿ï¼‰ã§ã‚‚å‹•ä½œã—ã¾ã™
            </div>
        </div>

        <div id="fileList" class="file-list" style="display: none;">
            <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <div id="fileItems"></div>
        </div>
        
        <div id="status" class="progress" style="display: none;">
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
        </div>

        <div style="text-align: center;">
            <button onclick="processData()" id="processBtn" style="display: none;">ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’é–‹å§‹</button>
            <button onclick="debugDateData()" id="debugBtn" class="debug-button" style="display: none;">æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒãƒƒã‚°</button>
            <button onclick="downloadExcel()" id="downloadBtn" disabled>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <h3>å‡¦ç†çµ±è¨ˆ</h3>
            <div id="statsContent"></div>
        </div>

        <div id="sentimentSummary" class="sentiment-summary" style="display: none;">
            <h3>ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æã‚µãƒãƒªãƒ¼</h3>
            <div id="sentimentContent"></div>
        </div>

        <div id="sampleResults" class="sample-results" style="display: none;">
            <h3>å‡¦ç†çµæœã‚µãƒ³ãƒ—ãƒ«</h3>
            <div id="sampleContent"></div>
        </div>
    </div>

    <script>
        let processedData = null;
        let rawData = null;
        let masterLabels = [
            'é£Ÿã¹ã‚‹', 'é£Ÿã¹ãªã„', 'åãæˆ»ã—ãƒ»ä¾¿ã®æ”¹å–„', 'ãã®ä»–', 'å®‰ã„',
            'é…é€ãƒ»æ¢±åŒ…', 'é«˜ã„ãƒ»å€¤ä¸Šã’', 'åããƒ»ä¾¿ãŒæ‚ªããªã‚‹', 'è³å‘³æœŸé™', 'ã‚¸ãƒƒãƒ‘ãƒ¼ãŒæ¬²ã—ã„'
        ];
        let labelConfig = []; // æ–°ã—ã„ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šé…åˆ—
        let uploadedFiles = {};
        let sentimentDataList = [];

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedFiles[file.name] = {
                            name: file.name,
                            data: e.target.result
                        };
                        updateFileList();
                        checkFiles();
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            
            if (Object.keys(uploadedFiles).length > 0) {
                fileList.style.display = 'block';
                fileItems.innerHTML = '';
                
                Object.values(uploadedFiles).forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.innerHTML = `
                        <span>${file.name}</span>
                        <button class="remove-file" onclick="removeFile('${file.name}')">å‰Šé™¤</button>
                    `;
                    fileItems.appendChild(item);
                });
            } else {
                fileList.style.display = 'none';
            }
        }

        function removeFile(fileName) {
            delete uploadedFiles[fileName];
            updateFileList();
            checkFiles();
        }

        function checkFiles() {
            const hasRawReview = Object.keys(uploadedFiles).some(name => 
                name.toLowerCase().includes('raw_review') || name.toLowerCase().includes('review')
            );
            
            if (hasRawReview) {
                document.getElementById('processBtn').style.display = 'inline-block';
                document.getElementById('debugBtn').style.display = 'inline-block';
                document.getElementById('status').style.display = 'block';
                document.getElementById('status').textContent = 'å‡¦ç†æº–å‚™å®Œäº†';
                
                // Master.xlsxãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã‚€ï¼ˆæ‹¡å¼µæ©Ÿèƒ½å¯¾å¿œï¼‰
                const masterFile = Object.values(uploadedFiles).find(file => 
                    file.name.toLowerCase().includes('master')
                );
                if (masterFile) {
                    const workbook = XLSX.read(masterFile.data);
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // æ‹¡å¼µå½¢å¼ã®ãƒã‚§ãƒƒã‚¯ï¼ˆBåˆ—ã¾ãŸã¯Cåˆ—ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ï¼‰
                    const hasExtendedFormat = data.some(row => row[1] || row[2]);
                    
                    if (hasExtendedFormat) {
                        // æ‹¡å¼µå½¢å¼ï¼ˆAåˆ—ï¼šãƒ©ãƒ™ãƒ«åã€Båˆ—ï¼šå„ªå…ˆåº¦ã€Cåˆ—ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                        labelConfig = data
                            .filter(row => row[0]) // Aåˆ—ãŒç©ºã§ãªã„è¡Œã®ã¿
                            .map(row => ({
                                name: row[0],                    // Aåˆ—ï¼šãƒ©ãƒ™ãƒ«å
                                priority: parseInt(row[1]) || 999, // Båˆ—ï¼šå„ªå…ˆåº¦ï¼ˆæœªæŒ‡å®šã¯æœ€ä½å„ªå…ˆï¼‰
                                patterns: row[2] ? row[2].split('|').filter(p => p.trim()) : [] // Cåˆ—ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ|åŒºåˆ‡ã‚Šï¼‰
                            }))
                            .sort((a, b) => a.priority - b.priority); // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
                        
                        console.log('ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', labelConfig);
                        document.getElementById('status').textContent = `å‡¦ç†æº–å‚™å®Œäº†ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®š: ${labelConfig.length}ä»¶ï¼‰`;
                    } else {
                        // å¾“æ¥å½¢å¼ï¼ˆAåˆ—ã®ã¿ï¼‰
                        labelConfig = [];
                        masterLabels = data.map(row => row[0]).filter(label => label);
                        console.log('å¾“æ¥å½¢å¼ã®Master.xlsxã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', masterLabels);
                    }
                } else {
                    // Master.xlsxãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                    labelConfig = [];
                }
            } else {
                document.getElementById('processBtn').style.display = 'none';
                document.getElementById('debugBtn').style.display = 'none';
                document.getElementById('status').style.display = 'none';
            }
        }

        // ä¿®æ­£ã•ã‚ŒãŸæ—¥ä»˜è§£æé–¢æ•°
        function parseDate(dateStr) {
            if (!dateStr) return { year: '', month: '', yearMonth: '', quarter: '' };
            
            console.log('å…¥åŠ›ã•ã‚ŒãŸæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿:', dateStr, 'ã‚¿ã‚¤ãƒ—:', typeof dateStr);
            
            let date = null;
            
            // 1. Excelã‚·ãƒªã‚¢ãƒ«å€¤ã®å ´åˆï¼ˆæ•°å€¤ã§25569ä»¥ä¸Šã®å€¤ï¼‰
            if (typeof dateStr === 'number' && dateStr > 25569) { // 1970/1/1ä»¥é™
                // Excelã‚·ãƒªã‚¢ãƒ«å€¤ã‚’JavaScriptæ—¥ä»˜ã«å¤‰æ›
                // Excelã¯1900/1/1ã‚’1ã¨ã™ã‚‹ãŒã€JavaScriptã¯1970/1/1ãŒåŸºæº–
                const excelEpoch = new Date(1899, 11, 30); // 1899/12/30
                date = new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000);
            }
            // 2. ã€Œ2024å¹´1æœˆã€å½¢å¼
            else if (typeof dateStr === 'string') {
                const yearMonthMatch = dateStr.match(/(\\d{4})å¹´(\\d{1,2})æœˆ/);
                if (yearMonthMatch) {
                    const year = parseInt(yearMonthMatch[1]);
                    const month = parseInt(yearMonthMatch[2]);
                    date = new Date(year, month - 1, 1);
                }
                // 3. ã€Œ2024/1/15ã€ã€Œ2024-01-15ã€ãªã©ã®ä¸€èˆ¬çš„ãªå½¢å¼
                else {
                    // æ–‡å­—åˆ—ã‚’æ¨™æº–çš„ãªæ—¥ä»˜ã¨ã—ã¦è§£æã‚’è©¦è¡Œ
                    const normalizedDate = dateStr.replace(/[å¹´æœˆæ—¥]/g, '/').replace(/-/g, '/');
                    const testDate = new Date(normalizedDate);
                    if (!isNaN(testDate.getTime())) {
                        date = testDate;
                    }
                }
            }
            
            // æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã®å‡¦ç†
            if (date && !isNaN(date.getTime())) {
                const year = date.getFullYear().toString();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const monthNum = parseInt(month);
                const quarter = `${year}Q${Math.ceil(monthNum / 3)}`;
                
                const result = {
                    year: year,
                    month: month,
                    yearMonth: `${year}å¹´${month}æœˆ`,
                    quarter: quarter
                };
                
                console.log('è§£æçµæœ:', result);
                return result;
            }
            
            console.log('æ—¥ä»˜è§£æå¤±æ•—:', dateStr);
            return { year: '', month: '', yearMonth: '', quarter: '' };
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®é–¢æ•°
        function debugDateData() {
            if (!rawData || rawData.length < 2) {
                const rawReviewFile = Object.values(uploadedFiles).find(file => 
                    file.name.toLowerCase().includes('raw_review') || file.name.toLowerCase().includes('review')
                );
                
                if (!rawReviewFile) {
                    alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const rawWorkbook = XLSX.read(rawReviewFile.data);
                const rawSheet = rawWorkbook.Sheets[rawWorkbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(rawSheet, { header: 1 });
            }
            
            console.log('=== æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('ãƒ˜ãƒƒãƒ€ãƒ¼:', rawData[0]);
            
            // æœ€åˆã®10è¡Œã®Båˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            for (let i = 1; i <= Math.min(10, rawData.length - 1); i++) {
                const dateValue = rawData[i][1]; // Båˆ—
                console.log(`${i}è¡Œç›® Båˆ—:`, dateValue, 'ã‚¿ã‚¤ãƒ—:', typeof dateValue);
                
                if (dateValue) {
                    const parsed = parseDate(dateValue);
                    console.log(`  â†’ è§£æçµæœ:`, parsed);
                }
            }
            
            alert('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚F12ã‚’æŠ¼ã—ã¦Consoleã‚¿ãƒ–ã‚’è¦‹ã¦ãã ã•ã„ã€‚');
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šã«ã‚ˆã‚‹åˆ†é¡é–¢æ•°
        function detectLabelsFromConfig(reviewText) {
            if (!reviewText) return 'ãã®ä»–';
            if (labelConfig.length === 0) {
                // Master.xlsxãŒãªã„å ´åˆã‚„å¾“æ¥å½¢å¼ã®å ´åˆã¯å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
                return detectLabels(reviewText);
            }
            
            const text = String(reviewText).toLowerCase();
            
            // å„ªå…ˆåº¦é †ã«åˆ¤å®šï¼ˆæ—¢ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
            for (const config of labelConfig) {
                if (config.patterns.length === 0) continue; // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                
                for (const pattern of config.patterns) {
                    try {
                        if (text.match(new RegExp(pattern, 'i'))) { // å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
                            console.log(`ãƒãƒƒãƒ: "${config.name}" - ãƒ‘ã‚¿ãƒ¼ãƒ³: "${pattern}"`);
                            return config.name;
                        }
                    } catch (e) {
                        console.warn(`ç„¡åŠ¹ãªæ­£è¦è¡¨ç¾: ${pattern}`, e);
                    }
                }
            }
            
            // ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚ãƒãƒƒãƒã—ãªã„å ´åˆã¯ã€Œãã®ä»–ã€
            const otherLabel = labelConfig.find(c => c.name === 'ãã®ä»–');
            return otherLabel ? otherLabel.name : 'ãã®ä»–';
        }

        // æ”¹è‰¯ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«æ¤œå‡ºé–¢æ•°ï¼ˆKåˆ—ã®å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ”¹å–„ç‰ˆï¼‰
        function detectLabels(reviewText) {
            if (!reviewText) return 'ãã®ä»–';
            const text = String(reviewText).toLowerCase();
            
            // å„ªå…ˆé †ä½ã®é«˜ã„ç‰¹å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
            
            // 1. é…é€ãƒ»æ¢±åŒ…é–¢é€£
            if (text.match(/é…é€|æ¢±åŒ…|ç™ºé€|å±Š[ãã„ãã‘]|ã¨ã©[ãã„ãã‘]|åˆ°ç€|åŒ…è£…|é…é”|å®…é…|è·ç‰©|ç®±|æ®µãƒœãƒ¼ãƒ«|ãƒ€ãƒ³ãƒœãƒ¼ãƒ«/)) {
                return 'é…é€ãƒ»æ¢±åŒ…';
            }
            
            // 2. ä¾¡æ ¼é–¢é€£ï¼ˆå€¤ä¸ŠãŒã‚Š/é«˜ã„ã®åˆ¤å®šã‚’å…ˆã«ï¼‰
            if (text.match(/å€¤ä¸Š[ã’ãŒã‚Š]|å€¤æ®µ.{0,5}ä¸ŠãŒ|ä¾¡æ ¼.{0,5}ä¸ŠãŒ|é«˜ããª[ã£ã‚Š]|å€¤æ®µ.{0,5}é«˜[ã„ãã‚]|é«˜ä¾¡|é«˜é¡|é«˜ã™ã|ãŸã‹[ã„ã]|é«˜ã„/)) {
                return 'é«˜ã„ãƒ»å€¤ä¸Šã’';
            }
            if (text.match(/å®‰[ã„ãã‚]|ã‚„ã™[ã„ãã‚]|å®‰ä¾¡|ãŠå¾—|ãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«|ã‚³ã‚¹ãƒ‘|æ‰‹é ƒ|æ‰‹ã”ã‚|ä½ä¾¡æ ¼|å‰²å®‰|ãŠè²·ã„å¾—/)) {
                return 'å®‰ã„';
            }
            
            // 3. è³å‘³æœŸé™
            if (text.match(/è³å‘³æœŸé™|æ¶ˆè²»æœŸé™|æœŸé™|æ—¥ä»˜|ä½¿ç”¨æœŸé™|æœ‰åŠ¹æœŸé™/)) {
                return 'è³å‘³æœŸé™';
            }
            
            // 4. ã‚¸ãƒƒãƒ‘ãƒ¼
            if (text.match(/ã‚¸ãƒƒãƒ‘ãƒ¼|ãƒãƒ£ãƒƒã‚¯|å¯†å°|ã‚¸ãƒƒãƒ—|ä¿å­˜.{0,10}(ä¸ä¾¿|å›°|ã§ããªã„)|è¢‹.{0,10}(é–‰|ç· )|ãƒ•ã‚¡ã‚¹ãƒŠãƒ¼/)) {
                return 'ã‚¸ãƒƒãƒ‘ãƒ¼ãŒæ¬²ã—ã„';
            }
            
            // 5. åããƒ»ä¾¿é–¢é€£ï¼ˆæ”¹å–„ã¨æ‚ªåŒ–ã‚’æ˜ç¢ºã«åŒºåˆ¥ï¼‰
            if (text.match(/(å|ã¯ã|å˜”å|åãæˆ»ã—).{0,20}(æ¸›[ã£ãŸã‚Š]|ãªããª[ã£ãŸã‚Š]|ã—ãªããª[ã£ãŸã‚Š]|æ”¹å–„|è‰¯ããª[ã£ãŸã‚Š]|æ¸›å°‘|æ²»[ã£ãŸã¾ã‚Š])|ä¾¿.{0,20}(è‰¯[ãã„ã‹]ãª[ã£ãŸã‚Š]|æ”¹å–„|èª¿å­ãŒè‰¯|å¿«èª¿|ã—ã£ã‹ã‚Š|æ­£å¸¸)|ã†ã‚“ã¡.{0,20}(è‰¯[ãã„ã‹]ãª[ã£ãŸã‚Š]|æ”¹å–„|ã—ã£ã‹ã‚Š)|æ¯›ç‰.{0,20}(æ¸›[ã£ãŸã‚Š]|ãªããª[ã£ãŸã‚Š]|å°‘ãª[ãã„])/)) {
                return 'åãæˆ»ã—ãƒ»ä¾¿ã®æ”¹å–„';
            }
            if (text.match(/å[ãã„ãŸãã‘]|ã¯ã|å˜”å|åãæˆ»[ã—ã™ã‚Š]|ã‚‚ã©[ã™ã—]|ä¸‹ç—¢|ã’ã‚Š|ä¾¿.{0,5}[ç·©æ‚ªè‡­]|ã†ã‚“ã¡.{0,10}[ç·©æ‚ªè‡­]|è»Ÿä¾¿|è¡€ä¾¿|ä¾¿ç§˜|ã¹ã‚“ã´/) && 
                !text.match(/(æ¸›[ã£ãŸã‚Š]|ãªããª[ã£ãŸã‚Š]|ã—ãªããª[ã£ãŸã‚Š]|æ”¹å–„|è‰¯ããª[ã£ãŸã‚Š])/)) {
                return 'åããƒ»ä¾¿ãŒæ‚ªããªã‚‹';
            }
            
            // 6. é£Ÿã¹ã‚‹ãƒ»é£Ÿã¹ãªã„ï¼ˆæœ€å¾Œã«åˆ¤å®šï¼‰
            if (text.match(/é£Ÿã¹(ã¦ãã‚Œ)?ãª[ã„ã‹ãã‘]|é£Ÿã¹.{0,5}ãã‚Œãª[ã„ã‹ãã‘]|é£Ÿã„ã¤[ã‹ãã].{0,5}(æ‚ª|ãªã„|ãƒ€ãƒ¡)|æ®‹[ã™ã—ã¡ã‚Š]|æ‹’å¦|å£ã«ã—ãªã„|è¦‹å‘ãã‚‚ã—ãªã„|åŒ‚ã„ã‚’å—…[ã„ã]ã ã ã‘|ãã£ã½|èˆˆå‘³.{0,5}ç¤ºã•ãª/)) {
                return 'é£Ÿã¹ãªã„';
            }
            if (text.match(/é£Ÿã¹[ã‚‹ã¦ãŸã‚Š]|ãŸã¹[ã‚‹ã¦ãŸã‚Š]|é£Ÿã„ã¤[ããã„ãŒ].{0,5}(è‰¯|ã„ã„|ã‚ˆ[ã„ãã‹])|å®Œé£Ÿ|ç¾å‘³[ã—ã]|ãŠã„ã—|å–œã‚“ã§.{0,5}é£Ÿã¹|ãƒã‚¯ãƒã‚¯|ãƒšãƒ­ãƒª|ãŒã£ã¤[ããã„]|å¤¢ä¸­|ã‚ˆãé£Ÿã¹|å¤§å¥½ã|ãŠæ°—ã«å…¥ã‚Š/)) {
                return 'é£Ÿã¹ã‚‹';
            }
            
            return 'ãã®ä»–';
        }

        // æ”¹è‰¯ã•ã‚ŒãŸã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æé–¢æ•°
        function analyzeSentiment(reviewText) {
            if (!reviewText) {
                return {
                    label: 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«',
                    score: 50,
                    reason: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®ãŸã‚åˆ¤å®šä¸å¯'
                };
            }
            
            const text = String(reviewText);
            let score = 50; // åŸºæº–ã‚¹ã‚³ã‚¢
            const reasons = [];
            
            // ãƒã‚¸ãƒ†ã‚£ãƒ–è¦ç´ ã®æ¤œå‡º
            if (text.match(/é£Ÿã¹[ã‚‹ã¦ãŸã‚Š](?!ãª)|ç¾å‘³[ã—ã]|ãŠã„ã—|å–œã‚“ã§|ãƒã‚¯ãƒã‚¯|å®Œé£Ÿ|ã‚ˆãé£Ÿã¹|å¤§å¥½ã/)) {
                score += 15;
                reasons.push('é£Ÿã„ã¤ããŒè‰¯ã„');
            }
            if (text.match(/æº€è¶³|è‰¯[ã„ãã‹ã‘](?!ãª)|æ°—ã«å…¥|ãŠæ°—ã«å…¥ã‚Š|ãƒªãƒ”ãƒ¼ãƒˆ|ã¾ãŸè²·|å®šç•ª|ãšã£ã¨/)) {
                score += 10;
                reasons.push('æº€è¶³åº¦ãŒé«˜ã„');
            }
            if (text.match(/(å|å˜”å).{0,20}(æ¸›|ãªããªã£ãŸ|æ”¹å–„)|ä¾¿.{0,20}è‰¯|å¥åº·|å…ƒæ°—|èª¿å­.{0,5}è‰¯/)) {
                score += 15;
                reasons.push('å¥åº·é¢ã§ã®æ”¹å–„');
            }
            if (text.match(/å®‰[ã„ãã‚]|ã‚„ã™[ã„ãã‚]|ãŠå¾—|ã‚³ã‚¹ãƒ‘|æ‰‹é ƒ/)) {
                score += 10;
                reasons.push('ä¾¡æ ¼æº€è¶³åº¦ãŒé«˜ã„');
            }
            if (text.match(/æ¯›ä¸¦ã¿.{0,10}(è‰¯|ç¶ºéº—|ãƒ„ãƒ¤|ã‚µãƒ©ã‚µãƒ©)|æ¯›è‰¶|æ¯›.{0,5}ãƒ„ãƒ¤ãƒ„ãƒ¤/)) {
                score += 10;
                reasons.push('æ¯›ä¸¦ã¿ã®æ”¹å–„');
            }
            
            // ãƒã‚¬ãƒ†ã‚£ãƒ–è¦ç´ ã®æ¤œå‡º
            if (text.match(/é£Ÿã¹(ã¦ãã‚Œ)?ãª[ã„ã‹ãã‘]|æ‹’å¦|æ®‹[ã™ã—]/)) {
                score -= 20;
                reasons.push('é£Ÿã„ã¤ããŒæ‚ªã„');
            }
            if (text.match(/å[ãã„ãŸã‘]|å˜”å|ä¸‹ç—¢|è»Ÿä¾¿|ä¾¿.{0,5}æ‚ª/) && !text.match(/(æ¸›|ãªããªã£ãŸ|æ”¹å–„)/)) {
                score -= 15;
                reasons.push('ä½“èª¿ä¸è‰¯ã®ç™ºç”Ÿ');
            }
            if (text.match(/é«˜[ã„ãã‚]|ãŸã‹[ã„ãã‚]|å€¤ä¸Š[ã’ãŒã‚Š]/)) {
                score -= 10;
                reasons.push('ä¾¡æ ¼ã¸ã®ä¸æº€');
            }
            if (text.match(/æ®‹å¿µ|ãŒã£ã‹ã‚Š|æœŸå¾…ã¯ãšã‚Œ|ãƒ€ãƒ¡|æœ€æ‚ª|äºŒåº¦ã¨|ã‚‚ã†è²·ã‚ãªã„/)) {
                score -= 15;
                reasons.push('æœŸå¾…ã¨ã®ä¹–é›¢');
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’0-100ã®ç¯„å›²ã«åã‚ã‚‹
            score = Math.max(0, Math.min(100, score));
            
            // ãƒ©ãƒ™ãƒ«ã®åˆ¤å®š
            let label = 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«';
            if (score >= 70) label = 'ãƒã‚¸ãƒ†ã‚£ãƒ–';
            else if (score <= 30) label = 'ãƒã‚¬ãƒ†ã‚£ãƒ–';
            
            // ç†ç”±ã®ç”Ÿæˆ
            let reason = '';
            if (reasons.length > 0) {
                reason = reasons.join('ã€') + 'ãŸã‚ã€‚';
            } else {
                reason = 'ç‰¹å®šã®è©•ä¾¡è¦ç´ ãŒè¦‹å½“ãŸã‚‰ãªã„ãŸã‚ä¸­ç«‹çš„ã¨åˆ¤å®šã€‚';
            }
            
            return {
                label: label,
                score: score,
                reason: reason
            };
        }

        // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆã¨è¡¨ç¤º
        function generateAndShowSentimentSummary() {
            const positive = sentimentDataList.filter(s => s.label === 'ãƒã‚¸ãƒ†ã‚£ãƒ–').length;
            const negative = sentimentDataList.filter(s => s.label === 'ãƒã‚¬ãƒ†ã‚£ãƒ–').length;
            const neutral = sentimentDataList.filter(s => s.label === 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«').length;
            const total = sentimentDataList.length;
            
            let summaryHTML = `
                <p><strong>ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:</strong> ${total}ä»¶</p>
                <p><strong>ãƒã‚¸ãƒ†ã‚£ãƒ–:</strong> ${positive}ä»¶ (${(positive/total*100).toFixed(1)}%)</p>
                <p><strong>ãƒã‚¬ãƒ†ã‚£ãƒ–:</strong> ${negative}ä»¶ (${(negative/total*100).toFixed(1)}%)</p>
                <p><strong>ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«:</strong> ${neutral}ä»¶ (${(neutral/total*100).toFixed(1)}%)</p>
                <h4>ä¸»ãªå‚¾å‘:</h4>
                <ul>
            `;
            
            if (positive > negative * 2) {
                summaryHTML += '<li>å…¨ä½“çš„ã«å¥½è©•ä¾¡ãŒå¤šãã€è£½å“ã«å¯¾ã™ã‚‹æº€è¶³åº¦ãŒé«˜ã„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚</li>';
            }
            if (negative > positive * 2) {
                summaryHTML += '<li>æ”¹å–„ãŒå¿…è¦ãªç‚¹ãŒå¤šãè¦‹å—ã‘ã‚‰ã‚Œã¾ã™ã€‚</li>';
            }
            if (Math.abs(positive - negative) < total * 0.1) {
                summaryHTML += '<li>è©•ä¾¡ãŒåˆ†ã‹ã‚Œã¦ãŠã‚Šã€å€‹ä½“å·®ã‚„å¥½ã¿ã®é•ã„ãŒå¤§ãã„ã‚ˆã†ã§ã™ã€‚</li>';
            }
            
            // ä¸»ãªãƒã‚¸ãƒ†ã‚£ãƒ–è¦å› ã®åˆ†æ
            const positiveReasons = {};
            sentimentDataList.filter(s => s.label === 'ãƒã‚¸ãƒ†ã‚£ãƒ–').forEach(s => {
                if (s.reason.includes('é£Ÿã„ã¤ããŒè‰¯ã„')) positiveReasons['é£Ÿã„ã¤ã'] = (positiveReasons['é£Ÿã„ã¤ã'] || 0) + 1;
                if (s.reason.includes('å¥åº·é¢ã§ã®æ”¹å–„')) positiveReasons['å¥åº·æ”¹å–„'] = (positiveReasons['å¥åº·æ”¹å–„'] || 0) + 1;
                if (s.reason.includes('ä¾¡æ ¼æº€è¶³åº¦')) positiveReasons['ä¾¡æ ¼'] = (positiveReasons['ä¾¡æ ¼'] || 0) + 1;
            });
            
            if (Object.keys(positiveReasons).length > 0) {
                summaryHTML += '<li>ãƒã‚¸ãƒ†ã‚£ãƒ–è©•ä¾¡ã®ä¸»ãªè¦å› ï¼š';
                const topReasons = Object.entries(positiveReasons).sort((a, b) => b[1] - a[1]).slice(0, 3);
                summaryHTML += topReasons.map(([reason, count]) => `${reason}(${count}ä»¶)`).join('ã€');
                summaryHTML += '</li>';
            }
            
            summaryHTML += '</ul>';
            
            document.getElementById('sentimentContent').innerHTML = summaryHTML;
            document.getElementById('sentimentSummary').style.display = 'block';
        }

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function processData() {
            const statusDiv = document.getElementById('status');
            const processBtn = document.getElementById('processBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            try {
                processBtn.disabled = true;
                statusDiv.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                
                // Raw_Review.xlsxã‚’æ¢ã™
                const rawReviewFile = Object.values(uploadedFiles).find(file => 
                    file.name.toLowerCase().includes('raw_review') || file.name.toLowerCase().includes('review')
                );
                
                if (!rawReviewFile) {
                    throw new Error('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const rawWorkbook = XLSX.read(rawReviewFile.data);
                const rawSheet = rawWorkbook.Sheets[rawWorkbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(rawSheet, { header: 1 });
                
                statusDiv.textContent = `ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­... (ç·è¡Œæ•°: ${rawData.length - 1})`;
                
                // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®æ•°è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                console.log('ãƒ˜ãƒƒãƒ€ãƒ¼:', rawData[0]);
                console.log('1è¡Œç›®ãƒ‡ãƒ¼ã‚¿:', rawData[1]);
                console.log('2è¡Œç›®ãƒ‡ãƒ¼ã‚¿:', rawData[2]);
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
                const headers = [...rawData[0], 'Låˆ—_ãƒ©ãƒ™ãƒ«', 'Måˆ—_å¹´', 'Nåˆ—_æœˆ', 'Oåˆ—_å¹´æœˆ', 'Påˆ—_ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ', 'Qåˆ—_ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼'];
                processedData = [headers];
                
                // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                sentimentDataList = [];
                
                // ãƒãƒƒãƒå‡¦ç†
                const batchSize = 100;
                const totalRows = rawData.length - 1;
                
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    
                    // â˜…ä¿®æ­£: Båˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼‰ã€Kåˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹10ï¼‰ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
                    const reviewDate = row[1]; // Båˆ—ï¼ˆ0ãƒ™ãƒ¼ã‚¹ãªã®ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼‰
                    const reviewText = row[10]; // Kåˆ—ï¼ˆ0ãƒ™ãƒ¼ã‚¹ãªã®ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹10ï¼‰
                    
                    // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆæœ€åˆã®5è¡Œã®ã¿ï¼‰
                    if (i <= 5) {
                        console.log(`${i}è¡Œç›® - æ—¥ä»˜:`, reviewDate, 'ãƒ¬ãƒ“ãƒ¥ãƒ¼:', reviewText?.substring(0, 50));
                    }
                    
                    const dateInfo = parseDate(reviewDate);
                    // â˜…ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šå¯¾å¿œ: æ–°ã—ã„åˆ†é¡é–¢æ•°ã‚’ä½¿ç”¨
                    const labels = detectLabelsFromConfig(reviewText);
                    const sentimentData = analyzeSentiment(reviewText);
                    
                    // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æçµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const sentimentFormatted = `ãƒ©ãƒ™ãƒ«: ${sentimentData.label}\\nã‚¹ã‚³ã‚¢: ${sentimentData.score}\\nç†ç”±: ${sentimentData.reason}`;
                    
                    const newRow = [...row, labels, dateInfo.year, dateInfo.month, dateInfo.yearMonth, sentimentFormatted, dateInfo.quarter];
                    processedData.push(newRow);
                    sentimentDataList.push(sentimentData);
                    
                    // é€²æ—æ›´æ–°
                    if (i % batchSize === 0) {
                        statusDiv.textContent = `å‡¦ç†ä¸­... ${i}/${totalRows} (${Math.round(i/totalRows*100)}%)`;
                        await new Promise(resolve => setTimeout(resolve, 10)); // UIã‚’æ›´æ–°
                    }
                }
                
                statusDiv.innerHTML = '<span class="success">å‡¦ç†å®Œäº†ï¼</span>';
                downloadBtn.disabled = false;
                
                // çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
                showStatistics();
                // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
                generateAndShowSentimentSummary();
                // ã‚µãƒ³ãƒ—ãƒ«çµæœã®è¡¨ç¤º
                showSampleResults();
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                processBtn.disabled = false;
            }
        }

        // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        function showStatistics() {
            const statsDiv = document.getElementById('stats');
            const statsContent = document.getElementById('statsContent');
            
            // å¹´æœˆåˆ¥é›†è¨ˆ
            const yearMonthStats = {};
            const labelStats = {};
            
            for (let i = 1; i < processedData.length; i++) {
                const yearMonth = processedData[i][14]; // Oåˆ—
                const labels = processedData[i][11]; // Låˆ—
                
                if (yearMonth) {
                    yearMonthStats[yearMonth] = (yearMonthStats[yearMonth] || 0) + 1;
                }
                
                // ãƒ©ãƒ™ãƒ«é›†è¨ˆï¼ˆå˜ä¸€ãƒ©ãƒ™ãƒ«ã¨ã—ã¦æ‰±ã†ï¼‰
                if (labels) {
                    labelStats[labels] = (labelStats[labels] || 0) + 1;
                }
            }
            
            let html = '<p><strong>ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:</strong> ' + (processedData.length - 1) + '</p>';
            html += '<p><strong>æœŸé–“:</strong> ' + Object.keys(yearMonthStats).sort()[0] + ' ï½ ' + 
                    Object.keys(yearMonthStats).sort().slice(-1)[0] + '</p>';
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šã®è¡¨ç¤º
            if (labelConfig.length > 0) {
                html += `<p><strong>ãƒ©ãƒ™ãƒ«è¨­å®š:</strong> ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆ${labelConfig.length}ä»¶ï¼‰</p>`;
            } else {
                html += '<p><strong>ãƒ©ãƒ™ãƒ«è¨­å®š:</strong> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</p>';
            }
            
            html += '<p><strong>ãƒ©ãƒ™ãƒ«åˆ¥ä»¶æ•°:</strong></p><ul>';
            Object.entries(labelStats).sort((a, b) => b[1] - a[1]).forEach(([label, count]) => {
                html += `<li>${label}: ${count}ä»¶</li>`;
            });
            html += '</ul>';
            
            statsContent.innerHTML = html;
            statsDiv.style.display = 'block';
        }

        // ã‚µãƒ³ãƒ—ãƒ«çµæœã‚’è¡¨ç¤º
        function showSampleResults() {
            const sampleDiv = document.getElementById('sampleResults');
            const sampleContent = document.getElementById('sampleContent');
            
            let html = '';
            for (let i = 1; i <= 5 && i < processedData.length; i++) {
                const row = processedData[i];
                const sentimentLines = row[15].split('\\n');
                html += `<div class="result-item">
                    <strong>ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> ${String(row[10]).substring(0, 100)}...<br>
                    <strong>ãƒ©ãƒ™ãƒ«:</strong> ${row[11]}<br>
                    <strong>å¹´æœˆ:</strong> ${row[14]}<br>
                    <strong>ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ:</strong><br>
                    ${sentimentLines.map(line => `&nbsp;&nbsp;${line}`).join('<br>')}
                </div>`;
            }
            
            sampleContent.innerHTML = html;
            sampleDiv.style.display = 'block';
        }

        // Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadExcel() {
            if (!processedData) return;
            
            // ã‚·ãƒ¼ãƒˆ1: å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(processedData);
            XLSX.utils.book_append_sheet(wb, ws1, 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿');
            
            // ã‚·ãƒ¼ãƒˆ2: çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆ3ã¤ã®è¡¨ã‚’å«ã‚€ï¼‰
            const statsData = createStatisticsSheet();
            const ws2 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws2, 'çµ±è¨ˆåˆ†æ');
            
            // ã‚·ãƒ¼ãƒˆ3: ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼
            const sentimentSummaryData = createSentimentSummarySheet();
            const ws3 = XLSX.utils.aoa_to_sheet(sentimentSummaryData);
            XLSX.utils.book_append_sheet(wb, ws3, 'ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            XLSX.writeFile(wb, 'ãƒšãƒƒãƒˆãƒ•ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æçµæœ.xlsx');
        }

        // çµ±è¨ˆã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ã¤ã®è¡¨ã‚’å«ã‚€ï¼‰
        function createStatisticsSheet() {
            const statsData = [['ãƒšãƒƒãƒˆãƒ•ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æçµæœ - çµ±è¨ˆåˆ†æ']];
            statsData.push([]);
            
            // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã®æº–å‚™
            const yearMonthLabelCounts = {};
            const quarterLabelCounts = {};
            const yearMonthTotals = {};
            const quarterTotals = {};
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°masterLabels
            const allLabels = new Set(labelConfig.length > 0 ? 
                labelConfig.map(c => c.name) : masterLabels);
            const allYearMonths = new Set();
            const allQuarters = new Set();
            
            // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            for (let i = 1; i < processedData.length; i++) {
                const yearMonth = processedData[i][14]; // Oåˆ—
                const quarter = processedData[i][16]; // Qåˆ—
                const label = processedData[i][11]; // Låˆ—ï¼ˆå˜ä¸€ãƒ©ãƒ™ãƒ«ï¼‰
                
                if (yearMonth && label) {
                    allYearMonths.add(yearMonth);
                    yearMonthTotals[yearMonth] = (yearMonthTotals[yearMonth] || 0) + 1;
                    
                    if (!yearMonthLabelCounts[yearMonth]) {
                        yearMonthLabelCounts[yearMonth] = {};
                    }
                    
                    yearMonthLabelCounts[yearMonth][label] = 
                        (yearMonthLabelCounts[yearMonth][label] || 0) + 1;
                }
                
                if (quarter && label) {
                    allQuarters.add(quarter);
                    quarterTotals[quarter] = (quarterTotals[quarter] || 0) + 1;
                    
                    if (!quarterLabelCounts[quarter]) {
                        quarterLabelCounts[quarter] = {};
                    }
                    
                    quarterLabelCounts[quarter][label] = 
                        (quarterLabelCounts[quarter][label] || 0) + 1;
                }
            }
            
            const sortedYearMonths = Array.from(allYearMonths).sort();
            const sortedQuarters = Array.from(allQuarters).sort();
            const sortedLabels = Array.from(allLabels);
            
            // è¡¨1: å¹´æœˆã”ã¨ã®å®Ÿæ•°æ¨ç§»
            statsData.push(['ã€è¡¨1ã€‘å¹´æœˆã”ã¨ã®å®Ÿæ•°æ¨ç§»']);
            statsData.push(['ãƒ©ãƒ™ãƒ«', ...sortedYearMonths]);
            
            sortedLabels.forEach(label => {
                const row = [label];
                sortedYearMonths.forEach(ym => {
                    row.push(yearMonthLabelCounts[ym] && yearMonthLabelCounts[ym][label] ? yearMonthLabelCounts[ym][label] : 0);
                });
                statsData.push(row);
            });
            
            // åˆè¨ˆè¡Œ
            const totalRow = ['åˆè¨ˆ'];
            sortedYearMonths.forEach(ym => {
                totalRow.push(yearMonthTotals[ym] || 0);
            });
            statsData.push(totalRow);
            
            // ç©ºè¡Œã§åŒºåˆ‡ã‚Š
            statsData.push([]);
            statsData.push([]);
            
            // è¡¨2: å¹´æœˆã”ã¨ã®å‰²åˆæ¨ç§»
            statsData.push(['ã€è¡¨2ã€‘å¹´æœˆã”ã¨ã®å‰²åˆæ¨ç§»ï¼ˆ%ï¼‰']);
            statsData.push(['ãƒ©ãƒ™ãƒ«', ...sortedYearMonths]);
            
            sortedLabels.forEach(label => {
                const row = [label];
                sortedYearMonths.forEach(ym => {
                    const count = yearMonthLabelCounts[ym] && yearMonthLabelCounts[ym][label] ? yearMonthLabelCounts[ym][label] : 0;
                    const total = yearMonthTotals[ym] || 1;
                    const percentage = ((count / total) * 100).toFixed(1);
                    row.push(percentage + '%');
                });
                statsData.push(row);
            });
            
            // ç©ºè¡Œã§åŒºåˆ‡ã‚Š
            statsData.push([]);
            statsData.push([]);
            
            // è¡¨3: ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼ã”ã¨ã®ã¾ã¨ã‚
            statsData.push(['ã€è¡¨3ã€‘ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼ã”ã¨ã®ã¾ã¨ã‚']);
            
            // å®Ÿæ•°éƒ¨åˆ†
            statsData.push(['ãƒ©ãƒ™ãƒ«ï¼ˆå®Ÿæ•°ï¼‰', ...sortedQuarters]);
            sortedLabels.forEach(label => {
                const row = [label];
                sortedQuarters.forEach(q => {
                    row.push(quarterLabelCounts[q] && quarterLabelCounts[q][label] ? quarterLabelCounts[q][label] : 0);
                });
                statsData.push(row);
            });
            
            // åˆè¨ˆè¡Œ
            const quarterTotalRow = ['åˆè¨ˆ'];
            sortedQuarters.forEach(q => {
                quarterTotalRow.push(quarterTotals[q] || 0);
            });
            statsData.push(quarterTotalRow);
            
            statsData.push([]);
            
            // å‰²åˆéƒ¨åˆ†
            statsData.push(['ãƒ©ãƒ™ãƒ«ï¼ˆå‰²åˆ%ï¼‰', ...sortedQuarters]);
            sortedLabels.forEach(label => {
                const row = [label];
                sortedQuarters.forEach(q => {
                    const count = quarterLabelCounts[q] && quarterLabelCounts[q][label] ? quarterLabelCounts[q][label] : 0;
                    const total = quarterTotals[q] || 1;
                    const percentage = ((count / total) * 100).toFixed(1);
                    row.push(percentage + '%');
                });
                statsData.push(row);
            });
            
            return statsData;
        }

        // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
        function createSentimentSummarySheet() {
            const summaryData = [['ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æã‚µãƒãƒªãƒ¼']];
            summaryData.push([]);
            
            const positive = sentimentDataList.filter(s => s.label === 'ãƒã‚¸ãƒ†ã‚£ãƒ–').length;
            const negative = sentimentDataList.filter(s => s.label === 'ãƒã‚¬ãƒ†ã‚£ãƒ–').length;
            const neutral = sentimentDataList.filter(s => s.label === 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«').length;
            const total = sentimentDataList.length;
            
            summaryData.push(['é …ç›®', 'ä»¶æ•°', 'å‰²åˆ']);
            summaryData.push(['ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', total, '100.0%']);
            summaryData.push(['ãƒã‚¸ãƒ†ã‚£ãƒ–', positive, `${(positive/total*100).toFixed(1)}%`]);
            summaryData.push(['ãƒã‚¬ãƒ†ã‚£ãƒ–', negative, `${(negative/total*100).toFixed(1)}%`]);
            summaryData.push(['ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', neutral, `${(neutral/total*100).toFixed(1)}%`]);
            
            summaryData.push([]);
            summaryData.push(['ä¸»ãªå‚¾å‘']);
            
            if (positive > negative * 2) {
                summaryData.push(['å…¨ä½“çš„ã«å¥½è©•ä¾¡ãŒå¤šãã€è£½å“ã«å¯¾ã™ã‚‹æº€è¶³åº¦ãŒé«˜ã„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚']);
            }
            if (negative > positive * 2) {
                summaryData.push(['æ”¹å–„ãŒå¿…è¦ãªç‚¹ãŒå¤šãè¦‹å—ã‘ã‚‰ã‚Œã¾ã™ã€‚']);
            }
            if (Math.abs(positive - negative) < total * 0.1) {
                summaryData.push(['è©•ä¾¡ãŒåˆ†ã‹ã‚Œã¦ãŠã‚Šã€å€‹ä½“å·®ã‚„å¥½ã¿ã®é•ã„ãŒå¤§ãã„ã‚ˆã†ã§ã™ã€‚']);
            }
            
            // æœˆåˆ¥ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆæ¨ç§»
            summaryData.push([]);
            summaryData.push(['æœˆåˆ¥ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆæ¨ç§»']);
            
            const monthSentiment = {};
            for (let i = 1; i < processedData.length; i++) {
                const yearMonth = processedData[i][14];
                const sentiment = processedData[i][15];
                
                if (yearMonth && sentiment) {
                    if (!monthSentiment[yearMonth]) {
                        monthSentiment[yearMonth] = {
                            'ãƒã‚¸ãƒ†ã‚£ãƒ–': 0,
                            'ãƒã‚¬ãƒ†ã‚£ãƒ–': 0,
                            'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«': 0
                        };
                    }
                    
                    const sentimentMatch = sentiment.match(/ãƒ©ãƒ™ãƒ«: (\\w+)/);
                    if (sentimentMatch) {
                        monthSentiment[yearMonth][sentimentMatch[1]]++;
                    }
                }
            }
            
            const sortedMonths = Object.keys(monthSentiment).sort();
            summaryData.push(['å¹´æœˆ', 'ãƒã‚¸ãƒ†ã‚£ãƒ–', 'ãƒã‚¬ãƒ†ã‚£ãƒ–', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«']);
            
            sortedMonths.forEach(month => {
                summaryData.push([
                    month,
                    monthSentiment[month]['ãƒã‚¸ãƒ†ã‚£ãƒ–'],
                    monthSentiment[month]['ãƒã‚¬ãƒ†ã‚£ãƒ–'],
                    monthSentiment[month]['ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«']
                ]);
            });
            
            return summaryData;
        }
    </script>
</body>
</html>